{% extends "layout2.html" %}
{% block title %}Classification History{% endblock %}

{% block content %}
<!-- 引入 p5.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>

<style>
    #controls {
        display: flex;
        justify-content: center;
        padding: 10px;
        background-color: transparent;
    }

    .button {
        margin: 0 20px;
        padding: 10px 20px;
        border: none;
        background-color: #bdc3c7;
        color: white;
        cursor: pointer;
        font-size: 16px;
        border-radius: 5px;
    }

    .button.active {
        background-color: #34495e;
    }

    #content {
        padding: 20px;
        max-width: 1100px;
        margin: 0 auto 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #attackChart {
        padding-right: 30px;
        margin-bottom: 20px;
    }

    /* 時間視覺化 */
    #time-visualization {
        display: none;
    }

    .time-filter {
        margin-top: 20px;
        text-align: center;
    }

    .heatmap {
        margin-top: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* type table */
    #type {
        width: 96%;
        border-collapse: collapse;
        margin: 10px auto;
        table-layout: fixed;
    }

    #type th:nth-child(1),
    #type td:nth-child(1) {
        width: 20%; /* Time欄寬度為 20% */
    }

    #type th:nth-child(2),
    #type td:nth-child(2) {
        width: 68%; /* Log欄寬度為 68% */
    }

    #type th:nth-child(3),
    #type td:nth-child(3) {
        width: 12%; /* Detail欄寬度為 12% */
    }

    /* time table */
    #historyTable {
        width: 96%;
        border-collapse: collapse;
        margin: 10px auto;
        table-layout: fixed;
    }

    #historyTable th:nth-child(1),
    #historyTable td:nth-child(1) {
        width: 18%; /* Time欄寬度為 18% */
    }

    #historyTable th:nth-child(2),
    #historyTable td:nth-child(2) {
        width: 46%; /* Log欄寬度為 46% */
    }

    #historyTable th:nth-child(3),
    #historyTable td:nth-child(3) {
        width: 28%; /* Type欄寬度為 28% */
    }

    #historyTable th:nth-child(4),
    #historyTable td:nth-child(4) {
        width: 8%; /* Detail欄寬度為 8% */
    }

    /* table common setting */
    table, th, td {
        border: 1px solid #ddd;
    }

    th, td {
        padding: 12px;
        text-align: center;
    }

    th {
        background-color: #34495e;
        color: white;
    }

    td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    /* 只在 "Attack Type" 頁面顯示卡片 */
    #cards-container {
        display: block;
    }

    #cards-container.hidden {
        display: none;
    }

    .detail-link {
        color: #000080;
    }

    #monthTimeTable.hidden {
        display: none;
    }

    #weekTimeTable.hidden {
        display: none;
    }

    #dayTimeTable.hidden {
        display: none;
    }
</style>

<!-- HTML part -->
<h1>Cowrie Log Attack Type Classification History</h1>

<p class="comment">Here you can explore the past events with visualization.</p>

<div id="controls">
    <button id="btn-attack" class="button active">Attack Type</button>
    <button id="btn-time" class="button">Time</button>
</div>

<div id="content">
    <!-- Attack Frequency Bar Chart Section -->
    <div id="visualization">
        <canvas id="attackChart"></canvas>
    </div>

    <!-- Type-based History Records Table -->
    <div id="cards-container" class="hidden">
        {% for attack in attack_data %}
            <br>
            <div class="attack-card">
                <h2>{{ attack.attack_type }}</h2>
                <div class="details">
                    <p><strong>You have encountered this attack type {{ attack.count }} times</strong></p>
                </div>
                <table id="type">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Input Cowrie Log</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in attack.records %}
                            <tr>
                                <td>{{ record.time }}</td>
                                <td>{{ record.input_log }}</td>
                                <td><a href="{% url 'ask_me:detail' %}?id={{ record.id }}" class="detail-link">Detail</a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}
    </div>

    <!-- Time-based Heatmap Section -->
    <div id="time-visualization">
        <!-- Time Filter -->
        <div class="time-filter">
            <label for="time-filter">Filter By:</label>
            <select id="time-filter">
                <option value="month">Month</option>
                <option value="week">Week</option>
                <option value="day">Day</option>
            </select>
            <button id="apply-filter" class="button">Apply Filter</button>
        </div>

        <!-- Heatmap -->
        <div class="heatmap" id="heatmap"></div>
        <br>

        <!-- Time-based History Records Table -->
        <div id="monthTimeTable" class="hidden">
            {% for attack in attack_data %}
            <br>
            <div class="attack-card">
                <h2>{{ attack.attack_type }}</h2>
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Input Cowrie Log</th>
                            <th>Attack Type</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in attack.records %}
                            <tr>
                                <td>month</td>
                                <td>month</td>
                                <td>month</td>
                                <td><a href="{% url 'ask_me:detail' %}?id={{ record.id }}" class="detail-link">Detail</a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>

        <div id="weekTimeTable" class="hidden">
            {% for attack in attack_data %}
            <br>
            <div class="attack-card">
                <h2>{{ attack.attack_type }}</h2>
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Input Cowrie Log</th>
                            <th>Attack Type</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in attack.records %}
                            <tr>
                                <td>week</td>
                                <td>week</td>
                                <td>week</td>
                                <td><a href="{% url 'ask_me:detail' %}?id={{ record.id }}" class="detail-link">Detail</a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>

        <div id="dayTimeTable" class="hidden">
            {% for attack in attack_data %}
            <br>
            <div class="attack-card">
                <h2>{{ attack.attack_type }}</h2>
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Input Cowrie Log</th>
                            <th>Attack Type</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in attack.records %}
                            <tr>
                                <td>day</td>
                                <td>day</td>
                                <td>day</td>
                                <td><a href="{% url 'ask_me:detail' %}?id={{ record.id }}" class="detail-link">Detail</a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>

    </div>
</div>

<a href="{% url 'ask_me:classification' %}" class="back-btn">Back To Classification Page</a>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Bar chart
    const attackType = {{ attackType|safe }};
    const frequency = {{ frequency|safe }};

    const ctx = document.getElementById('attackChart').getContext('2d');
    const attackChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: attackType,
            datasets: [{
                label: 'Attack Frequency',
                data: frequency,
                backgroundColor: 'rgba(52, 73, 94, 0.2)',
                borderColor: 'rgba(52, 73, 94, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            if (Number.isInteger(value)) {
                                return value; // 只顯示整數
                            }
                        }
                    }
                }
            }
        }
    });

    // Function to switch between "Attack Type" and "Time" views
    document.getElementById("btn-attack").addEventListener("click", function() {
        this.classList.add("active");
        document.getElementById("visualization").style.display = "block";
        document.getElementById("time-visualization").style.display = "none";
        document.getElementById("btn-time").classList.remove("active");
        document.getElementById("cards-container").classList.remove("hidden");

        sessionStorage.setItem("histState", "type");
    });

    document.getElementById("btn-time").addEventListener("click", function() {
        this.classList.add("active");
        document.getElementById("visualization").style.display = "none";
        document.getElementById("time-visualization").style.display = "block";
        document.getElementById("btn-attack").classList.remove("active");
        document.getElementById("cards-container").classList.add("hidden");

        // Draw the time-based heatmap here
        // drawHeatmap();

        document.getElementById('monthTimeTable').classList.remove('hidden');
        document.getElementById('weekTimeTable').classList.add('hidden');
        document.getElementById('dayTimeTable').classList.add('hidden');

        sessionStorage.setItem("histState", "time");
    });

    const timeData = {{ time_data|safe }};

    function drawHeatmap() {
        const heatmapDiv = document.getElementById('heatmap');

        // 熱點圖中的每一個資料項目加入換行樣式
        let heatmapContent = '<p>Time-based Heatmap</p>';
        timeData.forEach(item => {
            heatmapContent += `<div style="margin-bottom: 5px; word-wrap: break-word; white-space: normal;">
                <strong>${item.time}</strong>: 
                <span style="background-color: rgba(255, 0, 0, ${item.count / 20}); 
                    padding: 5px; color: white;">${item.count}</span>
            </div>`;
        });
        
        heatmapDiv.innerHTML = heatmapContent;
    }

    document.getElementById("apply-filter").addEventListener("click", function() {
        const filter = document.getElementById("time-filter").value; // 取得篩選器的選擇

        document.getElementById("visualization").style.display = "none";
        document.getElementById("cards-container").classList.add("hidden");

        if (filter === "month") {
            document.getElementById('monthTimeTable').classList.remove('hidden');
            document.getElementById('weekTimeTable').classList.add('hidden');
            document.getElementById('dayTimeTable').classList.add('hidden');
        } else if (filter === "week") {
            document.getElementById('monthTimeTable').classList.add('hidden');
            document.getElementById('weekTimeTable').classList.remove('hidden');
            document.getElementById('dayTimeTable').classList.add('hidden');
        } else {
            document.getElementById('monthTimeTable').classList.add('hidden');
            document.getElementById('weekTimeTable').classList.add('hidden');
            document.getElementById('dayTimeTable').classList.remove('hidden');
        }
    });

    state = sessionStorage.getItem("histState");
    if (state === "type") {
        document.getElementById("btn-attack").click();
    } else if (state === "time") {
        document.getElementById("btn-time").click();
    } else {
        document.getElementById("btn-attack").click();
    }
</script>

{% endblock %}